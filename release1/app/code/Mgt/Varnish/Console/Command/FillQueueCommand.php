<?php
 namespace Mgt\Varnish\Console\Command; use Symfony\Component\Console\Command\Command; use Symfony\Component\Console\Input\InputArgument; use Symfony\Component\Console\Input\InputOption; use Symfony\Component\Console\Input\InputInterface; use Symfony\Component\Console\Input\InputDefinition; use Symfony\Component\Console\Output\OutputInterface; class FillQueueCommand extends Command { const INPUT_STORE_ID = "\163\164\x6f\x72\x65\x2d\x69\x64"; const ENTITY_TYPE_CATEGORY = "\x63\141\164\145\147\x6f\x72\x79"; const ENTITY_TYPE_PRODUCT = "\x70\x72\157\x64\x75\x63\x74"; const URL_QUEUE_BATCH_SIZE = 2500; protected $logger; protected $storeManager; protected $categoryCollection; protected $urlQueueResource; protected $urlQueue; protected $numberOfUrls = 0; protected $categories = []; protected $state; public function __construct() { goto Fe355; Fe355: $objectManager = $this->getObjectManager(); goto f8645; Dc380: $this->urlQueue = $objectManager->get("\x5c\x4d\x67\164\134\126\141\162\156\x69\x73\x68\134\x4d\x6f\144\x65\154\x5c\125\x72\x6c\x51\x75\x65\x75\x65"); goto b192a; d0592: $this->storeManager = $objectManager->get("\134\x4d\x61\147\x65\156\x74\157\x5c\123\164\x6f\x72\145\134\x4d\157\144\145\154\134\x53\164\x6f\162\145\115\x61\x6e\x61\x67\145\x72\111\156\164\145\162\146\x61\x63\x65"); goto E4464; E4464: $this->categoryCollection = $objectManager->get("\x5c\x4d\141\x67\x65\156\164\x6f\134\x43\141\164\x61\x6c\157\x67\134\x4d\157\x64\x65\x6c\x5c\x52\145\163\157\x75\x72\x63\145\115\157\x64\x65\x6c\x5c\103\141\164\x65\147\x6f\162\171\134\103\x6f\154\x6c\145\143\x74\151\x6f\156"); goto a9541; b192a: parent::__construct(); goto b8fa7; f8645: $this->logger = $objectManager->get("\x5c\120\x73\x72\x5c\x4c\157\x67\x5c\x4c\x6f\147\147\x65\x72\111\156\164\x65\x72\146\141\x63\145"); goto d0592; a9541: $this->urlQueueResource = $objectManager->get("\x5c\115\x67\164\x5c\126\x61\162\156\x69\163\x68\x5c\x4d\157\x64\x65\154\134\122\x65\163\x6f\165\162\x63\x65\x4d\x6f\x64\x65\154\134\125\x72\x6c\x51\x75\145\x75\145"); goto Dc380; b8fa7: } protected function configure() { goto A2609; C5d0e: $this->setDefinition(new InputDefinition(array(new InputOption(self::INPUT_STORE_ID, null, InputOption::VALUE_OPTIONAL, '')))); goto c926a; B050d: $this->setDescription("\115\x47\x54\40\126\x61\162\x6e\151\x73\x68\x20\103\141\x63\150\145\x20\121\x75\x65\165\x65\x20\x46\x69\154\154\x65\162"); goto C5d0e; c926a: parent::configure(); goto D24f0; A2609: $this->setName("\x6d\147\x74\55\166\x61\162\156\151\x73\x68\x3a\146\x69\x6c\154\55\161\x75\145\x75\145"); goto B050d; D24f0: } protected function execute(InputInterface $input, OutputInterface $output) { try { goto ab887; A3ea9: $output->writeln(sprintf("\x3c\151\x6e\x66\x6f\x3e\45\163\x20\x55\122\x4c\163\40\x61\x64\x64\145\144\40\164\157\x20\x56\141\162\x6e\x69\x73\150\40\x51\165\145\165\145\x3c\57\151\x6e\146\x6f\76", $this->numberOfUrls)); goto e9ee9; Cf309: if (!$storeId) { goto B2ff8; } goto acc4e; Ae5a8: $this->addCategoryUrls($store); goto b5de5; B521a: B2ff8: goto Ae5a8; a37fc: return \Magento\Framework\Console\Cli::RETURN_SUCCESS; goto B9040; c56a3: if (!($this->numberOfUrls > 0)) { goto dcbec; } goto A3ea9; b5de5: $this->addProductUrls($store); goto c56a3; ab887: ini_set("\x6d\145\x6d\x6f\162\171\137\x6c\x69\155\151\x74", "\x32\60\x34\70\115"); goto F9873; F9873: $store = null; goto B3573; B3573: $storeId = (int) $input->getOption(self::INPUT_STORE_ID); goto Cf309; acc4e: try { $store = $this->storeManager->getStore($storeId); $this->storeManager->setCurrentStore($store); } catch (\Exception $e) { goto D54b2; d6a3b: return $this->showStores($output); goto cb5ed; D54b2: $output->writeln(sprintf("\74\x65\x72\x72\x6f\x72\x3e\x53\164\157\162\145\40\x77\x69\x74\x68\x20\x49\104\x20\x22\45\x73\x22\40\x64\157\x65\163\x20\156\x6f\x74\x20\x65\170\151\163\x74\x73\74\57\x65\162\162\x6f\x72\x3e", $storeId)); goto Fd53b; Dfdc7: $output->writeln(sprintf("\74\x63\x6f\x6d\x6d\x65\x6e\164\x3e\x41\166\x61\151\154\x61\142\x6c\145\40\123\164\157\162\x65\163\74\57\143\x6f\x6d\155\x65\156\164\x3e")); goto d6a3b; Fd53b: $output->writeln(''); goto Dfdc7; cb5ed: } goto B521a; e9ee9: dcbec: goto a37fc; B9040: } catch (\Exception $e) { goto d2041; c186f: $output->writeln(sprintf("\x3c\x65\x72\162\157\162\x3e\45\163\x3c\57\x65\x72\x72\157\x72\76", $errorMessage)); goto C42cd; C42cd: return \Magento\Framework\Console\Cli::RETURN_FAILURE; goto Ba892; d2041: $errorMessage = $e->getMessage(); goto c186f; Ba892: } } protected function addCategoryUrls(\Magento\Store\Model\Store $store = null) { goto fb05e; a6f75: e4a1a: goto ebfb9; C8643: $this->numberOfUrls += count($urls); goto a7700; C77e7: B7cee: goto bf286; bf286: $this->categoryCollection->addAttributeToSelect("\145\156\164\151\x74\x79\137\151\144"); goto Fcd13; b4e2f: if (!count($this->categories)) { goto c2f4f; } goto fd249; f79bf: $urls = []; goto Ee8fc; F99dc: $urlRewriteCollection->addEntityIdFilter($categoryIds); goto f207f; fb05e: $objectManager = $this->getObjectManager(); goto d490b; d1ee2: B5543: goto d4661; f8888: $urlRewriteCollection->addStoreFilter($storeId, false); goto C77e7; d4661: c2f4f: goto d3247; a5dba: if (!(null !== $store)) { goto B7cee; } goto e6e69; fd249: $categoryIds = array_keys($this->categories); goto c5b71; e6e69: $storeId = $store->getStoreId(); goto E7f88; d490b: $urlRewriteCollection = $objectManager->create("\134\x4d\x67\x74\x5c\126\141\162\156\x69\163\150\134\115\157\x64\x65\154\x5c\x52\145\x73\157\165\x72\x63\145\115\x6f\144\145\x6c\134\125\x72\x6c\x52\x65\167\162\x69\x74\x65\x5c\x55\162\x6c\x52\145\x77\x72\151\164\145\x43\x6f\x6c\154\145\x63\x74\151\x6f\x6e"); goto a5dba; E7f88: $this->categoryCollection->setStore($store); goto f8888; ebfb9: if (!count($urls)) { goto B5543; } goto C8643; Fcd13: foreach ($this->categoryCollection as $category) { $this->categories[$category->getId()] = $category; F6eea: } goto c290e; Ee8fc: foreach ($urlRewriteCollection as $urlRewrite) { goto Ded69; Ded69: $urlRewriteId = $urlRewrite->getUrlRewriteId(); goto Fc3d4; bbed7: C0ea4: goto ca65c; Ebb9b: $urlRewrites[$urlRewriteId] = $urlRewriteId; goto bbed7; ca65c: e0c34: goto d3a04; Fc3d4: if (isset($urlRewrites[$urlRewriteId])) { goto C0ea4; } goto F4778; F4778: $urls[] = ["\x73\x74\157\x72\x65\x5f\x69\144" => $urlRewrite->getStoreId(), "\x70\x61\x74\150" => $urlRewrite->getRequestPath(), "\160\x72\151\157\162\x69\164\171" => \Mgt\Varnish\Model\UrlQueue::PRIORITY_MEDIUM]; goto Ebb9b; d3a04: } goto a6f75; c5b71: $urlRewriteCollection->addEntityTypeFilter(self::ENTITY_TYPE_CATEGORY); goto F99dc; c290e: E4bff: goto b4e2f; f207f: $urlRewrites = []; goto f79bf; a7700: $this->urlQueue->addToQueue($urls); goto d1ee2; d3247: } protected function addProductUrls(\Magento\Store\Model\Store $store = null) { goto Af0da; a5179: $productVisibility = $objectManager->get("\x5c\115\x61\x67\x65\x6e\164\x6f\134\103\x61\x74\x61\154\x6f\147\134\x4d\x6f\144\x65\154\134\x50\x72\157\144\x75\143\164\x5c\126\x69\x73\x69\142\x69\x6c\151\164\171"); goto A913f; B1402: foreach ($this->categories as $category) { goto Be2d3; F7e74: a704a: goto f287d; Be2d3: $productCollection = $objectManager->create("\134\115\x61\147\145\156\164\x6f\x5c\x43\141\x74\141\154\157\x67\x5c\x4d\x6f\x64\145\x6c\x5c\x52\145\163\157\165\x72\x63\145\115\x6f\x64\x65\154\134\120\x72\x6f\x64\x75\143\164\x5c\103\157\x6c\x6c\x65\143\x74\x69\x6f\156"); goto D2511; a224e: C1d1a: goto B27f0; cd066: $i = 0; goto F7e74; e1547: $break = true; goto D3f88; e5f3d: $entityIds = []; goto e74e3; a29bb: $productCollection->setPageSize(self::URL_QUEUE_BATCH_SIZE); goto e5f3d; B27f0: $urlRewriteCollection->addEntityTypeFilter(self::ENTITY_TYPE_PRODUCT); goto aa048; f287d: $productCollection->clear(); goto E9359; fb216: d7d86: goto Aaf6d; E25ca: a3195: goto B388d; Bccd1: $urlRewriteCollection = $objectManager->create("\x5c\115\147\x74\x5c\126\x61\162\x6e\151\x73\x68\134\x4d\x6f\144\145\154\134\x52\x65\163\157\165\162\143\145\115\157\144\x65\154\x5c\x55\162\154\122\145\x77\x72\151\x74\145\134\x55\x72\154\122\145\x77\x72\x69\x74\145\103\157\154\154\x65\x63\x74\x69\x6f\x6e"); goto f7532; Dae16: $urlRewriteCollection->addStoreFilter($storeId, false); goto a224e; Ace77: $productCollection->addCategoryFilter($category); goto Fcc06; Ca37e: $productCollection->addStoreFilter($store); goto E25ca; D2511: $productCollection->addAttributeToSelect(["\145\156\x74\151\x74\171\x5f\151\144", "\163\164\141\x74\x75\163"]); goto Bf7e2; D3f88: goto Bce80; goto A7327; B957f: if (false === empty($entityIds)) { goto e08fc; } goto e1547; A7327: e08fc: goto Bccd1; C13f4: if ($break == false) { goto a704a; } goto fb216; c17f5: $urlRewrites = []; goto f04bd; E7258: $this->numberOfUrls += count($urls); goto ebece; Bf7e2: $productCollection->addAttributeToFilter("\163\164\141\x74\x75\x73", ["\x69\x6e" => $productStatus->getVisibleStatusIds()]); goto D51e2; aae6b: b26a2: goto Bd9f0; ac697: foreach ($urlRewriteCollection as $urlRewrite) { goto F4d2a; E0495: Af613: goto dd24e; c5b67: Fd43c: goto E0495; fdd90: $urlRewrites[$urlRewriteId] = $urlRewriteId; goto c5b67; fbe9d: $urls[] = ["\x73\x74\x6f\162\x65\x5f\151\x64" => $urlRewrite->getStoreId(), "\x70\141\164\150" => $urlRewrite->getRequestPath(), "\160\162\151\157\162\x69\x74\x79" => \Mgt\Varnish\Model\UrlQueue::PRIORITY_LOW]; goto fdd90; F4d2a: $urlRewriteId = $urlRewrite->getUrlRewriteId(); goto a6f53; a6f53: if (isset($urlRewrites[$urlRewriteId])) { goto Fd43c; } goto fbe9d; dd24e: } goto aae6b; D51e2: $productCollection->setVisibility($productVisibility->getVisibleInSiteIds()); goto Ace77; E9359: if (!(null !== $store)) { goto a3195; } goto Ca37e; B388d: $productCollection->setCurPage(++$i); goto a29bb; Bd9f0: if (!count($urls)) { goto ec3a1; } goto E7258; Fcc06: $break = false; goto cd066; Aaf6d: d6e7c: goto b8adf; c6d40: Bce80: goto C13f4; ebece: $this->urlQueue->addToQueue($urls); goto b0d55; aa048: $urlRewriteCollection->addEntityIdFilter($entityIds); goto c17f5; e74e3: foreach ($productCollection as $product) { goto Be9e5; C2b1b: $entityIds[$productId] = $productId; goto F67ba; F334e: f9780: goto ce54f; C81cc: if (isset($productIds[$productId])) { goto E3ec2; } goto Be52f; B1f5c: if (!(true === empty($parentIds))) { goto ada56; } goto cfe6a; Be9e5: $productId = $product->getId(); goto C81cc; F74b3: E3ec2: goto fe97e; e307e: goto B1009; goto F334e; fe97e: Ddb82: goto C4eae; ce54f: $productIds[$productId] = $productId; goto Bc574; c278a: B1009: goto F74b3; cfe6a: $productIds[$productId] = $productId; goto C2b1b; a8c15: $parentIds = $configurableProduct->getParentIdsByChild($productId); goto B1f5c; Bc574: $entityIds[$productId] = $productId; goto c278a; F67ba: ada56: goto e307e; Be52f: if ("\x63\157\156\146\151\147\x75\162\x61\142\154\x65" == $product->getTypeId()) { goto f9780; } goto a8c15; C4eae: } goto F12fb; f04bd: $urls = []; goto ac697; F12fb: fdb1c: goto B957f; c859b: $storeId = $store->getStoreId(); goto Dae16; b0d55: ec3a1: goto c6d40; f7532: if (!(null !== $store)) { goto C1d1a; } goto c859b; b8adf: } goto Fa340; c305b: $objectManager = $this->getObjectManager(); goto ac84d; Fa340: ffe97: goto c489a; C6f74: $productStatus = $objectManager->get("\x5c\115\141\x67\145\x6e\164\157\x5c\x43\x61\x74\x61\154\x6f\x67\x5c\x4d\x6f\x64\x65\x6c\x5c\x50\162\x6f\144\165\143\164\134\x41\x74\164\162\151\x62\x75\164\x65\x5c\123\157\x75\x72\143\x65\134\x53\x74\141\x74\x75\163"); goto a5179; ac84d: $configurableProduct = $objectManager->get("\x5c\x4d\x61\x67\x65\x6e\164\x6f\x5c\103\157\156\146\x69\147\165\162\141\142\x6c\x65\120\162\x6f\x64\165\143\164\x5c\115\x6f\144\x65\x6c\134\x52\145\x73\x6f\x75\162\143\x65\115\157\x64\145\154\134\x50\162\157\x64\x75\x63\x74\x5c\124\171\160\145\134\103\157\x6e\146\151\147\165\162\x61\142\x6c\145"); goto C6f74; A913f: $productIds = []; goto B1402; c489a: D9d34: goto f9702; Af0da: if (!count($this->categories)) { goto D9d34; } goto c305b; f9702: } protected function getObjectManager() { $objectManager = \Magento\Framework\App\ObjectManager::getInstance(); return $objectManager; } protected function showStores(OutputInterface $output) { goto a24e7; ec6ca: $stores = $this->storeManager->getStores(); goto e1a8a; A6716: $table->setHeaders(["\x53\164\157\x72\145\x20\111\x44", "\x42\x61\x73\145\x20\125\122\x4c"]); goto ec6ca; e1a8a: foreach ($stores as $store) { goto Dcbca; F94eb: $table->addRow($row); goto C0f8d; C0f8d: Ff0b8: goto A9341; Dcbca: $row = [$store->getStoreId(), $store->getBaseUrl()]; goto F94eb; A9341: } goto C021d; a24e7: $table = $this->getHelperSet()->get("\x74\141\x62\x6c\x65"); goto A6716; C021d: b89e6: goto D3626; D3626: $table->render($output); goto F7cd3; F7cd3: } }
